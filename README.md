# accel-align-rmi

A version of [Accel-Align](https://github.com/raja-appuswamy/accel-align-release) using the RMI index.

**_See also the [original README](./README_og.md)._**

---

## 0 | Clone
The repository can be cloned by running the following command:
```
git clone --recursive https://github.com/IlariaPilo/accel-align-rmi
```

## 1 | Download a reference string
The script [/data/download.sh](./data/download.sh) can be used to download and post-process a reference string. The downloaded string is called `hg37.fna`, and it is saved in the current working directory.

## 2 | Build the index
The index can be built by simply running:
```
bash index.sh <reference_string.fna>
```
The script generates an output directory `<reference_string>_index`, containing all index-related files. These files include:
- `keys_uint32` and `pos_uint32` - two binary files storing keys and positions in the index, respectively. The first value in both files is a uint64 counter of the number of entries. Then, `kes_uint32` contains pairs of uint32 (key, cumulative_pos), where cumulative_pos is the sum of positions associated to a key lower than the current one. `pos_uint32` contains simply a list of uint32 positions.
- `optimizer.out` - the output of the RMI hyperparameter optimizer. It stores the 10 most promising architectures, as well as some statistics on their size and training time.
- `rmi_type.txt` - the architecture of the chosen RMI index.
- `<reference_string>_index.so` and `<reference_string>_index.sym` - the generated shared object for the index and the list of symbol names for the main functions. Notice that the list is necessary to avoid issues with different C++ standards.

## 3 | Call the aligner
The aligner can be built with `make`, and then run normally.

**_warning : up to now, only -t (number of threads) and -o (output file) options are available -> no -l! Only -l 16 is supported_**

Example
```
./accalign -t 4 -o accalign.sam ./data/hg37.fna ./data/sv-10m-100-r.fastq
```

## 4 | Utility folder
The `utility` folder contains some useful helper scripts.

### benchmark_local.sh
This [script](./utilities/benchmark_local.sh) can be used to run automatic benchmarks comparing accel-align with/without learned index.
It should be moved from the `utility` directory into a parent directory containing both `accel-align-rmi` and `accel-align-release`. Programs should be already compiled.

Usage
```
    bash benchmark_local.sh <thread_number> [<number_of_executions>]
Runs some benchmarks for accel-align (with/without rmi index).
Executables should be already present (just run make).
Indices should be built in advance (with -l 16 option).
<thread_number> specifies the number of threads to be used.
<number_of_executions> is the number of times every program is called [default is 10]
```

### binary_print.py
This [script](./utilities/binary_print.sh) can be used to take a look inside the keys_uint32 or pos_uint32 binary files.
More in general, it can print whatever binary file having the structure:

\<number of entries> (uint64) <br>
\<list of keys> (uint32 each) 

Usage
```
    python3 binary_print.py <filename> [<direction>] [<number_of_entries>]
Prints the entries of <filename> file.
If <number_of_entries> is not specified, 10 entries are displayed.
If <direction> is 'forward' or not provided, it reads from the beginning of the file.
If <direction> is 'backward', it reads from the end of the file.
```
### key_2_string.py
This [script](./utilities/key_2_string.py) takes a uint32 key and recovers the 16-char long kmer that generated it.

Usage
```
    python3 key_2_string.py <key>
Takes the key and converts it into a kmer, assuming its length is 16.
```

### search_key.py
This [script](./utilities/search_key.py) searches if a given key is present in a file. It is supposed to be used only on keys_uint32 files (that is, key files generated by index.sh).

Usage
```
    python search_key.py <filename> <key>
Search the key in <filename> file.
Passing 'min' as key returns the minimum, passing 'max' the maximum.
```

## 5 | Docker folder
**_warning : the Docker folder functionality is currently broken, as the newest version of tbb is not compatible with accel-align :(_** 

To run the program inside a container, run the following commands:
```
cd docker
bash build.sh
bash run.sh <data_directory>
```
where _data_directory_ is the directory storing the reference string (and the results).

The generated credentials are (with `sudo` permissions):
```
USER: aligner
PASSWORD: password
```